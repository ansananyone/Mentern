# 🔍 "오늘의 추천 업무 0건" 문제 분석 및 해결

## ❌ 문제 상황
- 프론트엔드에서 "오늘의 추천 업무"가 **총 0건**으로 표시됨
- Supabase에는 **42개의 open tasks** 존재 (더미 제외 시 39개)

## 🔍 원인 분석

### Supabase 데이터 확인
```
✅ 총 open tasks: 42개
✅ 더미 org_id tasks: 3개 (22222222-2222-2222-2222-222222222222)
✅ 유효한 tasks: 39개
```

### 문제의 근본 원인

#### 이전 코드의 문제점
```typescript
// HomeScreen - 이전 코드
const { data: tasksData } = await supabase
  .from('tasks')
  .select('*')
  .eq('status', 'open')
  .limit(2)  // ⚠️ 문제: 2개만 조회

// 프론트엔드에서 더미 필터링
const validTasks = tasksData.filter(task => 
  !task.org_id?.startsWith('22222222')
)
```

**문제 시나리오:**
1. Supabase가 반환한 처음 2개 tasks가 모두 더미 `org_id`를 가진 경우
2. 프론트엔드 필터링 후 → **0개**
3. 결과: "오늘의 추천 업무 0건" 표시

### 실제 발생 상황
- `tasks` 테이블의 처음 5개 중 **3개가 더미 org_id**
- `.limit(2)` 시 더미가 포함될 확률이 높음
- 더미 필터링 후 **0개 또는 1개**만 남을 수 있음

## ✅ 해결 방법

### 수정된 코드

#### HomeScreen
```typescript
// 더미를 DB 레벨에서 제외하고 조회
const { data: tasksData } = await supabase
  .from('tasks')
  .select('*')
  .eq('status', 'open')
  .not('org_id', 'eq', '22222222-2222-2222-2222-222222222222')  // ⭐ 핵심
  .limit(2)

console.log('[HomeScreen] 조회된 tasks:', tasksData?.length || 0)

// org_id가 있는 tasks만 필터링
const validTasks = tasksData.filter(task => task.org_id)
```

#### TasksScreen
```typescript
// 더미를 DB 레벨에서 제외하고 조회
const { data: tasksData } = await supabase
  .from('tasks')
  .select('*')
  .eq('status', 'open')
  .not('org_id', 'eq', '22222222-2222-2222-2222-222222222222')  // ⭐ 핵심
  .limit(20)

console.log('[TasksScreen] 조회된 tasks:', tasksData?.length || 0)

// org_id가 있는 tasks만 필터링
const validTasks = tasksData.filter(task => task.org_id)
```

### 핵심 변경사항

#### Before (문제 있음)
```
Supabase → 2개 조회 (더미 포함 가능) → 프론트엔드 필터링 → 0~2개
```

#### After (수정 완료)
```
Supabase → 더미 제외 → 2개 조회 (유효한 것만) → 프론트엔드 필터링 → 2개
```

### 쿼리 테스트 결과

```bash
# 수정된 쿼리
curl 'https://.../tasks?status=eq.open&org_id=not.eq.22222222-2222-2222-2222-222222222222&limit=2'

# 결과
[
  {
    "id": "e7fcaf38-...",
    "title": "PCB 검사 공정 품질 모니터링",
    "org_id": "9436eeca-c24a-5c27-9885-e7e0ff62e861"
  },
  {
    "id": "63f937a3-...",
    "title": "도료 품질 샘플 검사",
    "org_id": "d2d9fd44-9aad-4f82-a5a0-b134c3b85e26"
  }
]
```

✅ **2개의 유효한 tasks 정상 조회**

## 📊 기술적 세부사항

### UUID 타입 필터링
- ❌ `.not('org_id', 'like', '22222222%')` → 에러 (UUID는 like 연산 불가)
- ✅ `.not('org_id', 'eq', '22222222-2222-2222-2222-222222222222')` → 성공

### 디버깅 로그 추가
```typescript
console.log('[HomeScreen] 조회된 tasks:', tasksData?.length || 0)
console.log('[TasksScreen] 조회된 tasks:', tasksData?.length || 0)
```

브라우저 콘솔에서 실시간 확인 가능

## 🎯 결과

### 수정 전
- ❌ 오늘의 추천 업무: 0건
- ❌ 태스크 화면: 불확실

### 수정 후
- ✅ 오늘의 추천 업무: 2건 (유효한 tasks만)
- ✅ 태스크 화면: 20건 (유효한 tasks만)
- ✅ 더미 데이터 자동 제외
- ✅ 전화번호 정상 표시

## 🧪 확인 방법

1. **브라우저 새로고침**
2. **홈 화면 확인**
   - "오늘의 추천 업무" 섹션에 2개 tasks 표시
3. **콘솔 확인**
   ```
   [HomeScreen] 조회된 tasks: 2
   [HomeScreen] ✅ org_profiles 조회 성공: { 총_회사수: 2, ... }
   [HomeScreen] ✅ 최종 tasks 데이터: [...]
   ```
4. **태스크 화면 이동**
   - 최대 20개 tasks 표시

## 📝 요약

### 문제
- DB 쿼리 시 더미 데이터가 포함되어, 프론트엔드 필터링 후 0건이 됨

### 해결
- **DB 레벨에서 더미 제외** (`.not('org_id', 'eq', '...')`)
- 유효한 데이터만 조회하여 항상 올바른 개수 표시

### 효과
- ✅ 안정적인 데이터 표시
- ✅ 불필요한 네트워크 트래픽 감소
- ✅ 디버깅 로그로 문제 추적 용이

---

**상태: ✅ 완료**
**예상 결과: 홈 화면에 2건의 추천 업무 정상 표시**


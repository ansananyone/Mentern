# 🔐 Supabase 로그인 구현 상태 분석

## 📊 현재 상황 요약

### ✅ 백엔드: 인증 시스템 준비 완료
백엔드 개발자가 **Supabase Auth를 활용한 인증 시스템**을 구현해놓았습니다.

### ⚠️ 프론트엔드: 하드코딩된 사용자 ID 사용 중
프론트엔드는 아직 **토큰 기반 인증을 구현하지 않음**, 테스트용 고정 ID 사용 중입니다.

---

## 🔍 상세 분석

### 1. Supabase Auth 시스템 (백엔드)

#### ✅ GoTrue 인증 서버 활성화
```json
{
  "version": "v2.180.0",
  "name": "GoTrue",
  "description": "GoTrue is a user registration and authentication API"
}
```
- Supabase의 공식 인증 서버 **GoTrue** 정상 동작 중
- 회원가입, 로그인, JWT 토큰 발급 기능 사용 가능

#### ✅ users 테이블 구조
```
public.users 테이블:
- id: UUID (앱에서 사용하는 사용자 ID)
- auth_uid: UUID (Supabase Auth의 사용자 ID)
- role: TEXT (senior/partner/admin)
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

**핵심 구조:**
```
auth.users (Supabase Auth)
    ↓ auth_uid로 연결
public.users (앱 DB)
    ↓ id로 연결
public.profiles (사용자 프로필)
```

#### 현재 등록된 사용자
```
사용자 1:
  - id (앱용): 11111111-1111-1111-1111-111111111111
  - auth_uid: 9431c533-8d1c-4a20-bda9-0f7f437ef417
  - role: senior
  - 이름: 김철수
  - 전화: 010-5000-6000
```

### 2. 프론트엔드 현재 상태

#### ❌ 하드코딩된 사용자 ID
```typescript
// app/page.tsx:61
const CURRENT_USER_ID = '11111111-1111-1111-1111-111111111111'
```

#### ❌ 토큰 기반 인증 미구현
```typescript
// lib/supabase.ts
export const supabase = createClient(supabaseUrl, supabaseAnonKey)
```
- **Anon Key만 사용** (공개 키)
- 사용자 세션 관리 없음
- JWT 토큰 검증 없음

#### 현재 데이터 접근 방식
```typescript
// 모든 API 호출에서 하드코딩된 ID 사용
const { data } = await supabase
  .from('profiles')
  .select('*')
  .eq('user_id', CURRENT_USER_ID)  // ⚠️ 하드코딩
  .single()
```

### 3. RPC 함수 (백엔드 제공)

백엔드에서 제공하는 함수들:
```
✅ get_user_activity_summary - 사용자 활동 요약
✅ get_task_disabled_reasons - 태스크 비활성화 이유
✅ match_tasks_for_user - 사용자 매칭 태스크
✅ build_profile_embedding_text - 프로필 임베딩
✅ build_task_embedding_text - 태스크 임베딩
✅ build_org_embedding_text - 회사 임베딩
✅ hash_embedding - 임베딩 해시
```

---

## 🎯 프론트엔드에서 해야 할 작업

### 1단계: Supabase Auth 클라이언트 설정
```typescript
// lib/supabase.ts
import { createClient } from '@supabase/supabase-js'

export const supabase = createClient(
  supabaseUrl,
  supabaseAnonKey,
  {
    auth: {
      persistSession: true,  // ⭐ 세션 저장
      autoRefreshToken: true,  // ⭐ 토큰 자동 갱신
      detectSessionInUrl: true  // ⭐ URL에서 세션 감지
    }
  }
)
```

### 2단계: 로그인 화면 구현
```typescript
// 로그인 함수
const handleLogin = async (phone: string, password: string) => {
  const { data, error } = await supabase.auth.signInWithPassword({
    phone: phone,
    password: password
  })
  
  if (error) {
    toast({ title: "로그인 실패", description: error.message })
    return
  }
  
  // data.user.id = auth_uid
  // users 테이블에서 앱용 user_id 조회 필요
  const { data: userData } = await supabase
    .from('users')
    .select('id')
    .eq('auth_uid', data.user.id)
    .single()
  
  // 앱 전역에서 사용할 user_id 설정
  setCurrentUserId(userData.id)
}
```

### 3단계: 세션 관리
```typescript
// 세션 확인
useEffect(() => {
  supabase.auth.getSession().then(({ data: { session } }) => {
    if (session) {
      // 로그인 상태
      fetchUserData(session.user.id)
    } else {
      // 로그인 필요
      showLoginScreen()
    }
  })
  
  // 세션 변경 감지
  const { data: authListener } = supabase.auth.onAuthStateChange(
    (event, session) => {
      if (event === 'SIGNED_IN') {
        // 로그인됨
      } else if (event === 'SIGNED_OUT') {
        // 로그아웃됨
      }
    }
  )
  
  return () => {
    authListener?.subscription.unsubscribe()
  }
}, [])
```

### 4단계: 하드코딩 제거
```typescript
// Before (현재)
const CURRENT_USER_ID = '11111111-1111-1111-1111-111111111111'

// After (수정 필요)
const [currentUserId, setCurrentUserId] = useState<string | null>(null)

// 세션에서 가져오기
const getUserIdFromSession = async () => {
  const { data: { session } } = await supabase.auth.getSession()
  if (!session) return null
  
  const { data } = await supabase
    .from('users')
    .select('id')
    .eq('auth_uid', session.user.id)
    .single()
  
  return data?.id
}
```

---

## 🔑 백엔드 개발자에게 확인할 사항

### 1. 인증 방식
- ✅ **Phone + Password?**
- ✅ **Email + Password?**
- ✅ **OTP (인증번호)?**
- ✅ **소셜 로그인?**

### 2. 회원가입 플로우
```
사용자 회원가입 요청
  ↓
auth.users 생성 (Supabase Auth)
  ↓
public.users 생성 (auth_uid 연결)
  ↓
public.profiles 생성 (user_id 연결)
```
→ **트리거나 RPC 함수로 자동화되어 있는지?**

### 3. RLS (Row Level Security) 정책
- 현재 `anon` 키로 모든 데이터 접근 가능
- 로그인 후 **각 사용자가 본인 데이터만 접근**하도록 RLS 설정 필요
- 예: `profiles` 테이블
  ```sql
  -- 본인 프로필만 조회 가능
  CREATE POLICY "Users can view own profile"
  ON profiles FOR SELECT
  USING (auth.uid() = (SELECT auth_uid FROM users WHERE id = user_id));
  ```

### 4. 토큰 사용 방식
- **JWT 토큰을 API 요청에 자동 포함?**
- Supabase 클라이언트가 자동으로 처리하는지?
- 커스텀 헤더가 필요한지?

---

## 📋 프론트엔드 작업 체크리스트

### 필수 작업
- [ ] 로그인 화면 UI 구현
- [ ] Supabase Auth 클라이언트 설정 (persistSession, autoRefreshToken)
- [ ] 세션 관리 로직 구현 (useEffect)
- [ ] 하드코딩된 `CURRENT_USER_ID` 제거
- [ ] 세션에서 user_id 동적으로 가져오기
- [ ] 로그아웃 기능 구현

### 선택 작업
- [ ] 회원가입 화면 구현 (백엔드 지원 시)
- [ ] 비밀번호 재설정 기능
- [ ] 프로필 업데이트 기능
- [ ] 토큰 만료 시 자동 로그아웃
- [ ] 보호된 라우트 (로그인 필요)

---

## 🎯 현재 데이터 흐름 vs 구현 필요 흐름

### 현재 (하드코딩)
```
앱 시작
  ↓
CURRENT_USER_ID = '11111111...'
  ↓
데이터 조회 (user_id = CURRENT_USER_ID)
  ↓
화면 표시
```

### 구현 필요 (토큰 기반)
```
앱 시작
  ↓
세션 확인
  ↓
세션 없음 → 로그인 화면
  ↓
로그인 성공 → JWT 토큰 발급
  ↓
auth_uid → user_id 조회
  ↓
데이터 조회 (user_id = 세션 user_id)
  ↓
화면 표시
```

---

## 💡 결론

### ✅ 준비된 것
1. Supabase Auth 서버 활성화
2. users 테이블 구조 (auth_uid 연결)
3. 테스트 사용자 데이터
4. RPC 함수들

### ⚠️ 필요한 것
1. **프론트엔드 로그인 화면**
2. **세션 관리 로직**
3. **하드코딩 제거**
4. **RLS 정책 (선택)**

### 📞 백엔드 개발자와 논의 필요
1. 로그인 방식 (phone/email/otp?)
2. 회원가입 자동화 여부
3. RLS 정책 설정 여부
4. 토큰 사용 방식

---

**상태: 백엔드 준비 완료, 프론트엔드 작업 대기 중**

